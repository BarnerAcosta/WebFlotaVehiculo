name: CI/CD Pipeline - WebFlotaVehiculo

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v3

      - name: Configurar JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Verificar versiones
        run: |
          java -version
          docker --version
          docker compose version

      - name: Construir imagen Docker
        run: |
          echo "üî® Construyendo imagen Docker..."
          docker compose build --no-cache
          echo "‚úÖ Imagen construida"

      - name: Verificar que el WAR se gener√≥ en el build
        run: |
          echo "üì¶ Extrayendo WAR de la imagen..."
          docker create --name temp_container $(docker compose config | grep 'image:' | tail -1 | awk '{print $2}') || \
          docker create --name temp_container webflotavehiculo-tomcat:latest || \
          docker compose run --rm --no-deps --entrypoint ls tomcat /build/dist/WebFlotaVehiculo.war
          echo "‚úÖ WAR verificado"

      - name: Levantar servicios
        run: |
          echo "üöÄ Levantando servicios..."
          docker compose up -d
          docker compose ps
          echo "‚úÖ Servicios levantados"

      - name: Esperar MySQL
        run: |
          echo "‚è≥ Esperando MySQL..."
          for i in {1..30}; do
            if docker exec mysql_concesionario mysqladmin ping -h localhost --silent 2>/dev/null; then
              echo "‚úÖ MySQL listo"
              exit 0
            fi
            echo "Intento $i/30..."
            sleep 2
          done
          echo "‚ùå MySQL no respondi√≥ a tiempo"
          exit 1

      - name: Esperar Tomcat
        run: |
          echo "‚è≥ Esperando Tomcat..."
          for i in {1..60}; do
            if curl -f http://localhost:8080/ 2>/dev/null; then
              echo "‚úÖ Tomcat listo"
              exit 0
            fi
            echo "Intento $i/60..."
            sleep 2
          done
          echo "‚ùå Tomcat no respondi√≥ a tiempo"
          docker logs tomcat_flota
          exit 1

      - name: Verificar base de datos
        run: |
          echo "üóÑÔ∏è Verificando base de datos..."
          docker exec mysql_concesionario mysql -u root concesionario -e "SHOW TABLES;"
          docker exec mysql_concesionario mysql -u root concesionario -e "SELECT COUNT(*) as vehiculos FROM vehiculo;"
          docker exec mysql_concesionario mysql -u root concesionario -e "SELECT COUNT(*) as tipos FROM tipovehi;"
          echo "‚úÖ Base de datos OK"

      - name: Verificar aplicaci√≥n web
        run: |
          echo "üåê Probando aplicaci√≥n..."
          curl -f http://localhost:8080/WebFlotaVehiculo/ || curl -f http://localhost:8080/
          echo "‚úÖ Aplicaci√≥n respondiendo"

      - name: Ver logs en caso de fallo
        if: failure()
        run: |
          echo "=== Estado de contenedores ==="
          docker compose ps
          echo ""
          echo "=== Logs de Tomcat ==="
          docker logs tomcat_flota || echo "No se pudo obtener logs de Tomcat"
          echo ""
          echo "=== Logs de MySQL ==="
          docker logs mysql_concesionario || echo "No se pudo obtener logs de MySQL"

      - name: Detener servicios
        if: always()
        run: docker compose down -v
